---
title: "Pràctica 2 - Aarón Puche i Roger Pardell"
output:
  pdf_document: default
  html_document:
    df_print: paged
    toc: yes
    toc_depth: 3
---

# 1. Descripció del dataset. Perquè és important i quina pregunta/problema pretén respondre?

Aquest darrer any hem vist com han augmentat considerablement les manifestacions del moviment Black Lives Matter amb motiu de [l'assassinat del ciutadà George Floyd en mans de l'actualment expolicia Derek Chauvin](https://www.europapress.es/internacional/noticia-sentencia-contra-expolicia-asesino-george-floyd-leera-16-junio-20210424033426.html). Però no pareix ser un cas aïllat. Ja durant el 2014 hi va haver forts disturbis a la ciutat de Fergusson com a resposta per l'assassinat a mans d'una policia de Michael Brown, un jove Afroamericà de 18 anys.

En aquest context, el Washington Post va començar a recollir tots els tirotejos amb víctimes mortals causades per policies als Estats Units. A [kaggle](https://www.kaggle.com/kwullum/fatal-police-shootings-in-the-us?select=ShareRaceByCity.csv) hem trobat un conjunt de datasets amb aquestes dades que ens poden ajudar a analitzar aquesta situació. A més de les dades dels enfrontaments amb víctimes mortals, també disposem de quatre datasets més amb informació relativa a les ciutats dels Estats Units. Aquesta informació ens serà molt útil per a analitzar més en profunditat si hi ha diferencies entre ciutats respecte a les ètnies predominants de cadascuna.

Algunes de les preguntes que volem respondre a partir de les dades són les següents:

- Hi ha diferències d'ingressos mitjans d'una ciutat depenent de la distribució d'ètnies.
- Hi ha ciutats on predominen persones d'unes ètnies sobre altres? Açò té alguna influència en les característiques de la ciutat?
- Les víctimes mortals pertanyen majoritàriament a alguna ètnia? En concret, hi ha diferències significatives respecte al percentatge de víctimes de població afro americana respecte a les altres?
- Predomina algun rang d'edat entre les persones que han sigut abatudes? Hi ha diferències entre ètnies?

Així, els datasets d'interès són els següents:
```{r, eval=TRUE, echo=TRUE}
df_householdIncome <- read.csv("/Users/rogerpardellcarrera/Desktop/UOC/Tipologia i cicle de vida de les dades/Pràctica 2/Dataset/MedianHouseholdIncome2015.csv")
df_poverty <- read.csv("/Users/rogerpardellcarrera/Desktop/UOC/Tipologia i cicle de vida de les dades/Pràctica 2/Dataset/PercentagePeopleBelowPovertyLevel.csv")
df_highSchool <- read.csv("/Users/rogerpardellcarrera/Desktop/UOC/Tipologia i cicle de vida de les dades/Pràctica 2/Dataset/PercentOver25CompletedHighSchool.csv")
df_policeKilling <- read.csv("/Users/rogerpardellcarrera/Desktop/UOC/Tipologia i cicle de vida de les dades/Pràctica 2/Dataset/PoliceKillingsUS.csv")
df_shareRace <- read.csv("/Users/rogerpardellcarrera/Desktop/UOC/Tipologia i cicle de vida de les dades/Pràctica 2/Dataset/ShareRaceByCity.csv")


head(df_policeKilling)
dim(df_policeKilling)
head(df_householdIncome)
dim(df_householdIncome)
head(df_poverty)
dim(df_poverty)
head(df_highSchool)
dim(df_highSchool)
head(df_shareRace)
dim(df_shareRace)
```

El primer mostra els totes les víctimes mortals en mans de la policia. En total, tenim 2535 observacions i 14 atributs, entre els quals hi trobem l'edat, l'estat i la ciutat on ha succeït i la manera en que han mort.

Els altres quatre conjunts són formats per unes 29300 observacions (entre 9268 i 29329), i un total de 10 atributs diferents. Cada observació és una ciutat americana, i els atributs són valors demogràfics i econòmics d'aquestes ciutats, per exemple, el percentatge de persones segons raça, la mediana dels ingressos familiars, etc.

Aquests cinc conjunts aporten les característiques individuals de les víctimes, així com les variables ambientals de les ciutats on han succeït els assassinats. Així, se'ns permet fer una anàlisi més holística de la situació.


# 2. Integració i selecció de les dades d’interès a analitzar.

Carreguem les llibreries que utilitzarem
```{r, eval=TRUE, echo=TRUE}
library(dplyr)
library(ggplot2)
library(magrittr)
```

Canviem el nom de les columnes
```{r, eval=TRUE, echo=TRUE}
colnames(df_householdIncome)[1] <- "area_geografica"
colnames(df_poverty)[1] <- "area_geografica"
colnames(df_highSchool)[1] <- "area_geografica"
colnames(df_shareRace)[1] <- "area_geografica"
```

Merge els distins df:
```{r, eval=TRUE, echo=TRUE}
USAv1 <- merge(df_highSchool, df_poverty, by.x=c("area_geografica", "City"), by.y=c("area_geografica", "City"))
USAv2 <- merge(USAv1, df_householdIncome, by.x=c("area_geografica", "City"), by.y=c("area_geografica", "City"))
USA <- merge(USAv2, df_shareRace, by.x=c("area_geografica", "City"), by.y=c("area_geografica", "City"))
```

Normalitzem els noms de les ciutats:
```{r, eval=TRUE, echo=TRUE}
USA$City <- gsub(" CDP| city| town|\\.| ","", USA$City)
df_policeKilling$city <- gsub(" County| Parish|[^[:alnum:]]","",df_policeKilling$city)
```

Merge del dataframe ambtingut amb df_policeKilling i neteja i preparació de les dades:
```{r, eval=TRUE, echo=TRUE}
df_clean <- merge(df_policeKilling, USA, by.x=c("state", "city"), by.y=c("area_geografica", "City"))
df_clean$id <- NULL
# Convertim el camp date de tipus character a tipus date
df_clean %<>% mutate(date=as.Date(date, format = "%d/%m/%y"))
rownames(df_clean) <- 1:nrow(df_clean)
```

# 3. Neteja de les dades.

Primer, netejarem el conjunt de dades amb les víctimes. 

Tractar camp Median.Income:
```{r, eval=TRUE, echo=TRUE}
table(df_clean$Median.Income)[1:5]
# Hem vist que la variable Median.Income te el valor "-" i "(X)", els subtituim per 0
df_clean[df_clean$Median.Income == "-",]$Median.Income <- "0"
df_clean[df_clean$Median.Income == "(X)",]$Median.Income <- "0"
# Convertim la variable a tipus numeric
df_clean$Median.Income <- as.numeric(df_clean$Median.Income)
# Calculem la mitjana i la asignem als valors que haviem subtituit abans
mean_income <- mean(df_clean[df_clean$Median.Income > 0,]$Median.Income)
df_clean$Median.Income[df_clean$Median.Income == 0] <- mean_income
```

Continuem amb el tractament de les dades:

- Pasarem les variables: manner_of_death, armed, gender, race, threat_level i flee a tipus factor.
- I les variables: percent_completed_hs, poverty_rate, share_white, share_asian, share_black, share_native_american i share_hispanic a tipus numeric.

```{r, eval=TRUE, echo=TRUE}
df_clean$manner_of_death <- as.factor(df_clean$manner_of_death)
df_clean$armed <- as.factor(df_clean$armed)
df_clean$gender <- as.factor(df_clean$gender)
df_clean$race <- as.factor(df_clean$race)
df_clean$threat_level <- as.factor(df_clean$threat_level)
df_clean$flee <- as.factor(df_clean$flee)
df_clean$percent_completed_hs <- as.numeric(df_clean$percent_completed_hs)
df_clean$poverty_rate <- as.numeric(df_clean$poverty_rate)
df_clean$share_white <- as.numeric(df_clean$share_white)
df_clean$share_asian <- as.numeric(df_clean$share_asian)
df_clean$share_black <- as.numeric(df_clean$share_black)
df_clean$share_native_american <- as.numeric(df_clean$share_native_american)
df_clean$share_hispanic <- as.numeric(df_clean$share_hispanic)
head(df_clean)
```


## Valors buits i extrems

Una vegada tenim les dades en el format que volem, comprovem si hi ha algun valor buit entot el dataframe:
```{r, eval=TRUE, echo=TRUE}
colSums(is.na(df_clean))
```
__age__

Vegem que tenim 71 edats desconegudes.
```{r echo=TRUE, message=FALSE, warning=FALSE}
boxplot(df_clean$age)$out
```
Tenim uns quants valors extrems en la variable edat, que corresponen a edats majors de 70 anys. Com aquest valors podrien influir en la mitjana, anema a assignar als valors NA la mediana, que es mes robusta contra aquests efectes.
```{r echo=TRUE, message=FALSE, warning=FALSE}
df_clean$age[is.na(df_clean$age)] <- median(df_clean$age[!is.na(df_clean$age)])
colSums(is.na(df_clean))
```

Ya no tenim valors NA en cap variable. Comprovem si hi ha elements amb cadena buida.
```{r echo=TRUE, message=FALSE, warning=FALSE}
colSums(df_clean == "")
```
__date__

Ens indica que hi ha valors NA en date, ho comprovem.
```{r echo=TRUE, message=FALSE, warning=FALSE}
which(is.na(df_clean$date))
```

En la comprovació ens diu que no hi ha camp valor de date amb NA.

__armed__

Com son sols 8 registres, els eliminarem
```{r echo=TRUE, message=FALSE, warning=FALSE}
df_clean <- df_clean[df_clean$armed != "",]
```

__race__

Aquestes dades serà una mica mes complicat, ja que no son valors numèrics, si no classes a les que pot pertanyer el registre.
Vegem com es distribueixen.
```{r echo=TRUE, message=FALSE, warning=FALSE}
table(df_clean$race)
```
Qui mes tenim es de gent "White" pero no podem assignar els 167 registres a white ja que aço podria despres fer-nos caure en analisis erronis ja que estariem inflant aquestes dades.  Com no es una gran quantitat de registres respecte al total, els eliminarem.

```{r echo=TRUE, message=FALSE, warning=FALSE}
df_clean <- df_clean[df_clean$race != "",]
```

__flee__
```{r echo=TRUE, message=FALSE, warning=FALSE}
table(df_clean$flee)
```

Tenim una situació semblant a la variable race. Com son sols 44 registres els eliminarem.
```{r echo=TRUE, message=FALSE, warning=FALSE}
df_clean <- df_clean[df_clean$flee != "",]
```

En aquest punt ja tenim les dades tractades. 
Comprovem:
```{r echo=TRUE, message=FALSE, warning=FALSE}
colSums(df_clean == "")
```

No tenim cap valor buit.

```{r echo=TRUE, message=FALSE, warning=FALSE}
str(df_clean)
```
I finalment, comprovem que estan amb el tipus de dades adequat adequat.


# 4 i 5. Anàlisi de les dades i representació dels resultats a partir de taules i gràfiques.

## Analisis exploratori de les dades

En aquest punt ens centrarem en les variables gender, race, poverty, hig school i age.

En primer lloc mirarem si la distribució de l'edat es igual a totes les races:

```{r, eval=TRUE, echo=TRUE}
ggplot(df_clean, aes(x = age, colour=race, group=race)) + geom_density()
```
Com es pot observat, les persones disparades de raça Black, Hispanic i Native-Americans tenen una distribucio bastant similars d'edats. Assian es una mica mes majors pero on es veu una diferencia mes gran es amb White, aquestes ultimes persones son mes majors, no s'agrupen tanten dades entonr als 20-30 anys com els altres.

Vegem tambe la distribucio per sexes.
```{r, eval=TRUE, echo=TRUE}
ggplot(df_clean) + geom_bar(map = aes(gender, fill=gender))
```

Podem destacar que, clarament, la gran majoria de persones disparades son homes.


Vegem ara com es distribueixen les races de les persones disparades:
```{r, eval=TRUE, echo=TRUE}
ggplot(df_clean) + geom_bar(map = aes(race, fill=race))
```

De qui mes registres tenim es de raça "blanca". Es llogic veure aquests resultats ja que la majoria de persones en estats units son de raça blanca, però, quina es la proporcio de victimes de cada respectiva raça respecta al total de persones d'eixa raça?

Per saber el total de la població de cada raça ens basarem en les dades de [Demographics of the United States](https://en.wikipedia.org/wiki/Demographics_of_the_United_States), de 2017. Les nostres dades, com podem veure, van de 2015 a 2017, aixi que s'ajustaran bastant be.

<img src="data/tabla_poblacio.PNG" width="500">

```{r, eval=TRUE, echo=TRUE}
summary(df_clean$date)
```

La data minima deles dades es 02/01/2015 i la màxima, 31/07/2017

Vegem el gràfic de les victimes de dispars tenint en compter la població total:
```{r, eval=TRUE, echo=TRUE}
races_total <- c((sum(df_clean$race == 'A') / 17186320), (sum(df_clean$race == 'B') / 40610815), (sum(df_clean$race == 'H') / 56510571), (sum(df_clean$race == 'N') / 2632102) , (sum(df_clean$race == 'O') / 15553808), (sum(df_clean$race == 'W') / 234370202))
races <- c('A', 'B', 'H', 'N', 'O', 'W')
barplot(races_total, names.arg = races)
```

Vegent el grafic amb les dades comparades amb el total de poblacio de cada raça pareix indicar que les persones de raça negra, natius americans i hispanos son mes probables de rebre un tir d'un policia que una persona blanca.

Per analitzar un poc mes en profunditat algunes posibles relacions entre les persones que han sigut disparadaes, discritzarem les variables percent_completed_hs i poverty_rate. Dividirem els seus valors en les franjes: 0-24, 25-49, 50-74 i 75-100.

```{r, eval=TRUE, echo=TRUE}
df_clean["range_highSchool"]<- cut(df_clean$percent_completed_hs, breaks = c(0,24,49,74,100), labels = c("0 - 24","25 - 49","50 - 74","75 - 100"))
df_clean["range_poverty"]<- cut(df_clean$poverty_rate, breaks = c(0,24,49,74,100), labels = c("0 - 24","25 - 49","50 - 74","75 - 100"))
```

```{r, eval=TRUE, echo=TRUE}
table(df_clean$range_highSchool)
table(df_clean$range_poverty)
```

```{r, eval=TRUE, echo=TRUE}
ggplot(df_clean) + geom_bar(map = aes(x = range_highSchool, fill=race), position = "fill")
```
Ens fixem amb els percentatges entre 50 i 100% perque en els anteriors hi han molt poques dades.
Pareix que les victimes blanques solen viure en ciutats amb un nievell d'estudis superiors. Destaca sobretot la diferencia amb la gent hispana.


```{r, eval=TRUE, echo=TRUE}
ggplot(df_clean) + geom_bar(map = aes(x = range_poverty, fill=race), position = "fill")
```

Per ultim, mitjançant histogrames vegem com es distribueixen els tipus d'amenaça que s'indiquin i la manera en que ha mort la persona:
```{r, eval=TRUE, echo=TRUE}
ggplot(df_clean) + geom_histogram(map = aes(age, fill = race), position = "fill")
ggplot(df_clean) + geom_histogram(map = aes(age, fill = threat_level), position = "fill")
ggplot(df_clean) + geom_histogram(map = aes(age, fill = manner_of_death), position = "fill")
```

```{r, eval=TRUE, echo=TRUE}
ggplot(df_clean) + geom_point(map = aes(x = share_white, y = Median.Income))
```

# Regressió
```{r}
df_clean_1 <- unique(df_clean[,c(1,2,14,15,16,17,18,19,20,21)])
```


```{r}
model_1 <- lm(formula = Median.Income ~ share_white + percent_completed_hs + poverty_rate, data = df_clean_1)
summary(model_1)
```

```{r}
model_2 <- lm(formula = poverty_rate ~ share_white + share_black, data = df_clean_1)
summary(model_2)
model_3 <- lm(formula = percent_completed_hs ~ share_white + share_black, data = df_clean_1)
summary(model_3)
```

## Clusters
```{r}
library(cluster)
library(fpc)
library(factoextra)

fviz_nbclust(df_clean_1[3:10], kmeans, method = "wss") +
   labs(subtitle = "Mètode Elbow") +
   xlab("Número de clústers") + 
   ylab("Suma total de quadrats dins dels grups")
```


# 6. Resolució del problema. A partir dels resultats obtinguts, quines són les conclusions? Els resultats permeten respondre al problema?
