---
title: "Pràctica 2 - Aarón Puche i Roger Pardell"
output:
  html_document:
    df_print: paged
    toc: yes
    toc_depth: 3
  pdf_document: default
---

# 1. Descripció del dataset. Perquè és important i quina pregunta/problema pretén respondre?

Aquest darrer any hem vist com han augmentat considerablement les manifestacions del moviment Black Lives Matter amb motiu de [l'assassinat del ciutadà George Floyd en mans de l'actualment expolicia Derek Chauvin](https://www.europapress.es/internacional/noticia-sentencia-contra-expolicia-asesino-george-floyd-leera-16-junio-20210424033426.html). Però no pareix ser un cas aïllat. Ja durant el 2014 hi va haver forts disturbis a la ciutat de Fergusson com a resposta per l'assassinat a mans d'una policia de Michael Brown, un jove Afroamericà de 18 anys.

En aquest context, el Washington Post va començar a recollir tots els tirotejos amb víctimes mortals causades per policies als Estats Units. A [kaggle](https://www.kaggle.com/kwullum/fatal-police-shootings-in-the-us?select=ShareRaceByCity.csv) hem trobat un conjunt de datasets amb aquestes dades que ens poden ajudar a analitzar aquesta situació. A més de les dades dels enfrontaments amb víctimes mortals, també disposem de quatre datasets més amb informació relativa a les ciutats dels Estats Units. Aquesta informació ens serà molt útil per a analitzar més en profunditat si hi ha diferencies entre ciutats respecte a les ètnies predominants de cadascuna.

Algunes de les preguntes que volem respondre a partir de les dades són les següents:

- Hi ha diferències d'ingressos mitjans d'una ciutat depenent de la distribució d'ètnies?
- Les ciutats es poden agrupar per alguna característica?
- Podem estimar els ingressos mitjans d'una ciutat?
- Les víctimes mortals pertanyen majoritàriament a alguna ètnia?
- Predomina algun rang d'edat entre les persones que han sigut abatudes? Hi ha diferències entre ètnies?

Així, els datasets d'interés són els següents:
```{r, eval=TRUE, echo=TRUE}
df_householdIncome <- read.csv("data/MedianHouseholdIncome2015.csv")
df_poverty <- read.csv("data/PercentagePeopleBelowPovertyLevel.csv")
df_highSchool <- read.csv("data/PercentOver25CompletedHighSchool.csv")
df_policeKilling <- read.csv("data/PoliceKillingsUS.csv")
df_shareRace <- read.csv("data/ShareRaceByCity.csv")

head(df_policeKilling)
dim(df_policeKilling)
head(df_householdIncome)
dim(df_householdIncome)
head(df_poverty)
dim(df_poverty)
head(df_highSchool)
dim(df_highSchool)
head(df_shareRace)
dim(df_shareRace)
```

El primer mostra totes les víctimes mortals en mans de la policia. En total, tenim 2535 observacions i 14 atributs, entre els quals hi trobem l'edat, l'estat i la ciutat on ha succeït i la manera en què han mort.

Els altres quatre conjunts són formats per unes 29300 observacions (entre 29268 i 29329), i un total de 10 atributs diferents. Cada observació és una ciutat americana, i els atributs són valors demogràfics i econòmics d'aquestes ciutats, per exemple, el percentatge de persones segons raça, la mediana dels ingressos familiars, etc.

Aquests cinc conjunts aporten les característiques individuals de les víctimes, així com les variables ambientals de les ciutats on han succeït els assassinats. Així, se'ns permet fer una anàlisi més holística de la situació.


# 2. Integració i selecció de les dades d’interès a analitzar.

Per a fer les nostres anàlisis crearem un dataset un amb totes les dades referents a informació sobre les ciutats relacionades amb la informació de les persones assassinades.

En primer lloc carreguem les llibreries que utilitzarem al llarg de la pràctica:
```{r, eval=TRUE, echo=TRUE}
library(dplyr)
library(ggplot2)
library(gridExtra)
library(magrittr)
```

Canviem el nom de la columna Geographic.area per a després fer la mescla de les dades:
```{r, eval=TRUE, echo=TRUE}
colnames(df_householdIncome)[1] <- "area_geografica"
colnames(df_poverty)[1] <- "area_geografica"
colnames(df_highSchool)[1] <- "area_geografica"
colnames(df_shareRace)[1] <- "area_geografica"
```

Mesclem els distints datasets i obtenim el dataset USA que contindrà tota la informació respectiva a les ciutats:
```{r, eval=TRUE, echo=TRUE}
USAv1 <- merge(df_highSchool, df_poverty, by.x=c("area_geografica", "City"), by.y=c("area_geografica", "City"))
USAv2 <- merge(USAv1, df_householdIncome, by.x=c("area_geografica", "City"), by.y=c("area_geografica", "City"))
USA <- merge(USAv2, df_shareRace, by.x=c("area_geografica", "City"), by.y=c("area_geografica", "City"))
```

Normalitzem els noms de les ciutats per fer la mescla de la informació de les ciutats i les persones assassinades:
```{r, eval=TRUE, echo=TRUE}
USA$City <- gsub(" CDP| city| town|\\.| ","", USA$City)
df_policeKilling$city <- gsub(" County| Parish|[^[:alnum:]]","",df_policeKilling$city)
```

Mesclem del dataset obtingut amb df_policeKilling:
```{r, eval=TRUE, echo=TRUE}
df_clean <- merge(df_policeKilling, USA, by.x=c("state", "city"), by.y=c("area_geografica", "City"))

# Eliminem aquesta, ja que en aquest cas no ens aporta informacio rellevant
df_clean$id <- NULL

# Convertim el camp date de tipus character a tipus date
df_clean %<>% mutate(date=as.Date(date, format = "%d/%m/%y"))

rownames(df_clean) <- 1:nrow(df_clean)
```

# 3. Neteja de les dades.

Tractar camp Median.Income:
```{r, eval=TRUE, echo=TRUE}
table(df_clean$Median.Income)[1:5]
# Hem vist que la variable Median.Income te el valor "-" i "(X)", els subtituim per 0
df_clean[df_clean$Median.Income == "-",]$Median.Income <- "0"
df_clean[df_clean$Median.Income == "(X)",]$Median.Income <- "0"
# Convertim la variable a tipus numeric
df_clean$Median.Income <- as.numeric(df_clean$Median.Income)
# Calculem la mitjana i la asignem als valors que haviem subtituit abans
mean_income <- mean(df_clean[df_clean$Median.Income > 0,]$Median.Income)
df_clean$Median.Income[df_clean$Median.Income == 0] <- mean_income
```

Continuem amb el tractament de les dades:

- Passarem les variables: manner_of_death, armed, gender, race, threat_level i flee a tipus factor.
- I les variables: percent_completed_hs, poverty_rate, share_white, share_asian, share_black, share_native_american i share_hispanic a tipus numeric.

```{r, eval=TRUE, echo=TRUE}
df_clean$manner_of_death <- as.factor(df_clean$manner_of_death)
df_clean$armed <- as.factor(df_clean$armed)
df_clean$gender <- as.factor(df_clean$gender)
df_clean$race <- as.factor(df_clean$race)
df_clean$threat_level <- as.factor(df_clean$threat_level)
df_clean$flee <- as.factor(df_clean$flee)
df_clean$percent_completed_hs <- as.numeric(df_clean$percent_completed_hs)
df_clean$poverty_rate <- as.numeric(df_clean$poverty_rate)
df_clean$share_white <- as.numeric(df_clean$share_white)
df_clean$share_asian <- as.numeric(df_clean$share_asian)
df_clean$share_black <- as.numeric(df_clean$share_black)
df_clean$share_native_american <- as.numeric(df_clean$share_native_american)
df_clean$share_hispanic <- as.numeric(df_clean$share_hispanic)
head(df_clean)
```


## Valors buits i extrems

Una vegada tenim les dades en el format que volem, comprovem si hi ha algun valor buit en tot el dataframe:
```{r, eval=TRUE, echo=TRUE}
colSums(is.na(df_clean))
```
__age__

Vegem que tenim 71 edats desconegudes.
```{r echo=TRUE, message=FALSE, warning=FALSE}
boxplot(df_clean$age)$out
```

Tenim uns quants valors extrems en la variable edat, que corresponen a edats majors de 70 anys. Com aquest valors podrien influir en la mitjana, anem a assignar als valors NA la mediana, que es mes robusta contra aquests efectes.
```{r echo=TRUE, message=FALSE, warning=FALSE}
df_clean$age[is.na(df_clean$age)] <- median(df_clean$age[!is.na(df_clean$age)])
colSums(is.na(df_clean))
```

Ja no tenim valors NA en cap variable. Comprovem si hi ha elements amb cadena buida.
```{r echo=TRUE, message=FALSE, warning=FALSE}
colSums(df_clean == "")
```
__date__

Ens indica que hi ha valors NA en date, ho comprovem.
```{r echo=TRUE, message=FALSE, warning=FALSE}
which(is.na(df_clean$date))
```

En la comprovació ens diu que no hi ha cap valor de date amb NA.

__armed__

Com son sols 8 registres, els eliminarem
```{r echo=TRUE, message=FALSE, warning=FALSE}
df_clean <- df_clean[df_clean$armed != "",]
```

__race__

Aquestes dades seran una mica més complicades, ja que no son valors numèrics, sinó classes a les que pot pertanyer el registre. Una possible solució seria la d'imputar tots aquest valors buits al grup majoritari.
Vegem com es distribueixen.
```{r echo=TRUE, message=FALSE, warning=FALSE}
table(df_clean$race)
```
El grup més nombrós és "White". Tot i aço, no podem assignar-li els 167 registres, ja que després podria fer-nos caure en anàlisis erronis pel fet d'estar inflant aquest grup. Com que no és una gran quantitat de registres respecte al total, les eliminarem.

```{r echo=TRUE, message=FALSE, warning=FALSE}
df_clean <- df_clean[df_clean$race != "",]
```

__flee__
```{r echo=TRUE, message=FALSE, warning=FALSE}
table(df_clean$flee)
```

Tenim una situació semblant a la variable race. Com que són sols 44 registres, els eliminarem.
```{r echo=TRUE, message=FALSE, warning=FALSE}
df_clean <- df_clean[df_clean$flee != "",]
```

En aquest punt ja tenim les dades tractades. 
Comprovem:
```{r echo=TRUE, message=FALSE, warning=FALSE}
colSums(df_clean == "")
```

No tenim cap valor buit.

```{r echo=TRUE, message=FALSE, warning=FALSE}
str(df_clean)
```
I finalment, comprovem que estan amb el tipus de dades adequat.

# 4 i 5. Anàlisi de les dades i representació dels resultats a partir de taules i gràfiques.

En aquest punt hem decidit ajuntar els punts 4 i 5 de l'enunciat per a fer en primer lloc una anàlisi mitjançant taules i gràfiques de les relacions que podem observar d'algunes variables que ens interessin i després passar a fer anàlisis amb més profunditat de les dades.

## Analisis exploratori de les dades

Ens centrarem en les relacions de les següents característiques: edat, gènere, ètnia, nivell de pobresa, nivell d'estudis, ingressos mitjans, el tipus d'amenaça i la forma de morir.

__Distribució per edats__

En primer lloc mirarem si la distribució de l'edat és igual a totes les races: ## afegir comprovació de normalitat
```{r, eval=TRUE, echo=TRUE}
ggplot(df_clean, aes(x = age, colour=race, group=race)) + geom_density()
```
Com es pot observar, les persones assassinades d'ètnia negra, hispana o nativa americana tenen una distribució de les edats bastant similar. Les edats de les persones asiàtiques són una mica més majors, però on es veu una diferència més gran és amb les persones blanques. Aquestes persones són més majors, no s'agrupen tant entorn als 20-30 anys com les altres.

__Distribució per gèneres__

Vegem també la distribució per sexes:
```{r, eval=TRUE, echo=TRUE}
ggplot(df_clean) + geom_bar(map = aes(gender, fill=gender))
```

Podem destacar que, clarament, la gran majoria de persones disparades són homes.

__Distribució d'ètnies__

Vegem ara com es distribueixen les races de les persones disparades:
```{r, eval=TRUE, echo=TRUE}
ggplot(df_clean) + geom_bar(map = aes(race, fill=race))
```

De qui més registres tenim és de les persones blanques. És lògic veure aquests resultats, ja que la majoria de persones en Estats Units són de blanques, però, quina és la proporció de víctimes de cada respectiva ètnia respecte al total de persones d'eixa ètnia?

així que s'ajustaran bastant bé.

<img src="data/tabla_poblacio.PNG" width="500">

```{r, eval=TRUE, echo=TRUE}
summary(df_clean$date)
```

La data mínima de les nostres dades és 02/01/2015 i la màxima, 31/07/2017.

Vegem el gràfic de les víctimes de tirs tenint en compte la població total de cada ètnia:
```{r, eval=TRUE, echo=TRUE}
races_total <- c((sum(df_clean$race == 'A') / 17186320), (sum(df_clean$race == 'B') / 40610815), (sum(df_clean$race == 'H') / 56510571), (sum(df_clean$race == 'N') / 2632102) , (sum(df_clean$race == 'O') / 15553808), (sum(df_clean$race == 'W') / 234370202))

# Etiquetes
races <- c('A', 'B', 'H', 'N', 'O', 'W')

barplot(races_total, names.arg = races)
```

Veient el gràfic amb les dades comparades amb el total de població de cada ètnia pareix indicar que les persones negres, natives americanes i hispanes són més probables de ser assassinades per la bala d'un policia que una persona blanca.

__Poverty i high school per ètnies__

Per analitzar un poc mes en profunditat algunes possibles relacions entre les persones que han sigut disparades, discretitzarem les variables percent_completed_hs i poverty_rate. Dividirem els seus valors en les franges: 0-24, 25-49, 50-74 i 75-100. ## Vist que quasi totes es concentren en 75-100, fem grups de freqüència igual?
```{r, eval=TRUE, echo=TRUE}
df_clean["range_highSchool"]<- cut(df_clean$percent_completed_hs, breaks = c(0,24,49,74,100), labels = c("0 - 24","25 - 49","50 - 74","75 - 100"))
df_clean["range_poverty"]<- cut(df_clean$poverty_rate, breaks = c(0,24,49,74,100), labels = c("0 - 24","25 - 49","50 - 74","75 - 100"))
```

Vegem la distribució de les dades en aquestes franges:
```{r, eval=TRUE, echo=TRUE}
table(df_clean$range_highSchool)
table(df_clean$range_poverty)
```

Analitzem-ho gràficament:
```{r, eval=TRUE, echo=TRUE}
ggplot(df_clean) + geom_bar(map = aes(x = range_highSchool, fill=race), position = "fill")
```

Ens fixem en els percentatges entre 50 i 100% perquè en els anteriors hi han molt poques dades.
Pareix que les víctimes blanques solen viure en ciutats amb un nivell d'estudis superiors. Destaca sobretot la diferència amb la gent hispana.

```{r, eval=TRUE, echo=TRUE}
ggplot(df_clean) + geom_bar(map = aes(x = range_poverty, fill=race), position = "fill")
```

En aquest gràfic ens ficarem en les franges de 0 a 50%. Les altres franges no tenen suficients dades per a ser significants.
Pareix que hi ha una diferència notable entre les persones blanques i negres. El percentatge de les persones blanques amb rang de pobresa entre el 0 i 25% és superior al de les persones blanques en el rang 25-50%. Amb les persones negres ocorre el contrari, hi ha un percentatge major de persones en rang de pobresa entre el 25-50% que entre el 0 i 25%.

__Median Income per ètnies__

En aquest apartat compararem la distribució de l'ingrés mitja de les ciutats tenint en compte la representació de cada ètnia.
```{r, eval=TRUE, echo=TRUE}
plot_share_white <- ggplot(df_clean) + geom_point(map = aes(x = share_white, y = Median.Income))
plot_share_black <- ggplot(df_clean) + geom_point(map = aes(x = share_black, y = Median.Income))
plot_share_native_american <- ggplot(df_clean) + geom_point(map = aes(x = share_native_american, y = Median.Income))
plot_share_asian <- ggplot(df_clean) + geom_point(map = aes(x = share_asian, y = Median.Income))
plot_share_hispanic <-ggplot(df_clean) + geom_point(map = aes(x = share_hispanic, y = Median.Income))

grid.arrange(plot_share_white, plot_share_black, plot_share_native_american, plot_share_asian, plot_share_hispanic, ncol=2)
```

Com és lògic les ciutats amb un alt percentatge de persones blanques són les que més tenim.

Pel que fa a la comparació en els ingressos en ciutats amb un percentatge molt elevat de cada ètnia podem veure certes diferències. Les ciutats amb alt percentatge de persones blanques són les que més alts ingressos presenten, encara que també hi ha ciutats amb alt percentatge de persones negres o asiàtiques amb mitjans-alts ingressos. En canvi, en ciutats amb alt percentatge de persones hispanes o natives americanes no hi tenen uns grans ingressos.

En els següents apartats ens centrarem en les persones blanques, negres i hispanes per a analitzar-les més, ja que són les que més dades tenim.

__Amenaça i manera en què ha mort la persona__

Per últim, mitjançant histogrames vegem com es distribueixen els percentatges dels tipus d'amenaça que s'indiquen i la manera en què ha mort la persona relacionant-ho amb l'edat:
```{r, eval=TRUE, echo=TRUE}
ggplot(df_clean) + geom_histogram(map = aes(age, fill = threat_level), position = "fill")
ggplot(df_clean) + geom_histogram(map = aes(age, fill = manner_of_death), position = "fill")
```

No pareix haver-hi una diferència notable entre el tipus d'amenaça i l'edat. La majoria es consideren atacs en la mateixa proporció.

I tampoc pareix que canvia la proporció de persones mortes per un tir o un tir i Taser amb l'edat. Tenim un pic al voltant dels 80 anys, però és possible que siga degut al fet que en eixes edats tinguem molt poques dades.

## Regressió

A partir de les dades ja tractades obtenim un dataset amb la informació respectiva a les ciutats.

Contindrà les variables:

- state
- city
- percent_completed_hs
- poverty_rate
- Median.Income
- share_white
- share_black
- share_native_american
- share_asian
- share_hispanic

```{r, eval=TRUE, echo=TRUE}
df_clean_cities <- unique(df_clean[,c(1,2,14,15,16,17,18,19,20,21)])
head(df_clean_cities)
```

En l'anàlisi preliminar de les dades hem vist certa deferència amb els ingressos de les ciutats, el percentatge d'estudis superats i el percentatge de pobresa amb les persones blanques negres i hispanes. Ens centrarem en aquestes dades per a fer les anàlisis de regressió.

En primer lloc, mirem com es relacionen aquestes variables.

Els valors d'aquesta taula estaran entre -1 i 1.

- 1 significara que hi ha una relació perfecta i positiva, és a dir, si augmenta un valor augmenta també l'altre.
- -1 significara també que hi ha una relació perfecta, però inversa. Quan augmente un valor, disminuirà l'altre.
- I 0 significarà que no hi ha relació.

```{r, eval=TRUE, echo=TRUE}
cor(df_clean_cities[,c(3,4,5,6,7,10)])
```
Veient els resultats podem destacar el següent:

- __percent_completed_hs:__ es relacionara en mesura amb poverty_rate i share_hispanic. Els dos en forma inversa, a més percentatge de pobresa o de persones hispanes, menys percentatge d'estudis superats tindrà la ciutat..
- __poverty_rate:__ Com pot semblar lògic, està fortament relacionada de forma inversa amb Median.Income. A major ingressos mitjans de les ciutats, menor percentatge de pobresa. També està relacionat de forma inversa amb percent_completed_hs. També pot ser lògic, a majors estudis superats, menor percentatge de pobresa.
- __Median.Income:__ Vegem també la relació inversa amb poverty_rate que ja hem explicat i una mica de relació directa (0.45) amb percent_completed_hs.

Ara calcularem tres models de regressió múltiple per a predir les variables Median.Income, poverty_rate i percent_completed_hs:

__Model 1:__ Predicció de l'ingrés mitja a partir de les variables share_white, share_black, share_hispanic, percent_completed_hs i poverty_rate.
```{r, eval=TRUE, echo=TRUE}
model_1 <- lm(formula = Median.Income ~ share_white + share_black + share_hispanic + percent_completed_hs + poverty_rate, data = df_clean_cities)
summary(model_1)
```

Amb els p-valor podem comprovar que totes les variables són significants per a la construcció del model.

Per comprovar la qualitat del model ens fixem en el valor obtingut de R-squared. Com més proper a 1 siga, millor s'ajustarà el model a les dades. Hem obtingut un `r round(summary(model_1)$r.squared,2)`. S'ajusta a les dades, però no amb una gran exactitud.

__Model 2:__ Predicció de la variable poverty_rate amb share_white, share_black, share_hispanic, percent_completed_hs i Median.Income.
```{r, eval=TRUE, echo=TRUE}
model_2 <- lm(formula = poverty_rate ~ share_white + share_black + share_hispanic + percent_completed_hs + Median.Income, data = df_clean_cities)
summary(model_2)
```

En aquest model podem observar que la variable share_black no és significativa per explicar el percentatge de pobresa, podríem llevar-la del model sense que tinga una gran influencia.

Pel que fa a l'ajust del model a les dades, hem obtingut un $R^2$ molt similar a l'anterior. $R^2$ = `r round(summary(model_2)$r.squared,2)`

__Model 3:__ Predicció del percentatge de persones que han superat els estudis superiors a partir de les variables share_white, share_black, share_hispanic, poverty_rate i Median.Income.
```{r, eval=TRUE, echo=TRUE}
model_3 <- lm(formula = percent_completed_hs ~ share_white + share_black  + share_hispanic + poverty_rate + Median.Income, data = df_clean_cities)
summary(model_3)
```

En aquest tenim dos variables que podríem llevar del model, ja que no són significants per a la seua construcció. Són les variables de share_white i share_black. El seu p-valor és superior a 0.05, per la qual cosa no tenen una gran influencia en explicar el percentatge d'estudis superats.

Quant al valor de $R^2$ és molt similar als altres dos models. $R^2$ = `r round(summary(model_2)$r.squared,2)`

Per finalitzar aquest punt, dir que no hem obtingut models que s'ajusten a la perfecció a les dades, però que sí que poden predir en certa eficàcia tant el percentatge de pobresa, el percentatge d'estudis superats o l'ingrés mitja de la ciutat.

## Clustering

En aquest punt agruparem el dataset de df_clean_cities en clusters per veure si les ciutats es podrien agrupar segons algunes característiques.

Aplicarem l'algoritme kmeans. Per saber quin k serà l'òptim farem servir el mètode del colze amb l'ajuda de la següent funció:
```{r, eval=TRUE, echo=TRUE}
library(cluster)
library(fpc)
library(factoextra)

fviz_nbclust(df_clean_cities[3:10], kmeans, method = "wss") +
   labs(subtitle = "Mètode Elbow") +
   xlab("Número de clústers") + 
   ylab("Suma total de quadrats dins dels grups")
```

Veient el gràfic elegim k = 5, ja que a partir d'aquest valor el pendent s'estabilitza.

Calcules els cluters amb la funció kmeans i vegem les variables comparades a la recerca de patrons que puguen seguir les dades:
```{r echo=TRUE, message=FALSE, warning=FALSE}
set.seed(12345)
clustering_cities <- kmeans(df_clean_cities[3:10], 5)
with(df_clean_cities[3:10], pairs(df_clean_cities[3:10], col=clustering_cities$cluster)) 
```

Pel que podem veure en aquest gràfic múltiple, la millor característica per la qual podem veure una divisió de les dades és Median.Income.

Vegem una de les seues gràfiques per separat, en concret veurem el gràfic de les variables Median.Income i percent_completed_hs:
```{r echo=TRUE, message=FALSE, warning=FALSE}
set.seed(12345)
clustering_income_hs <- kmeans(df_clean_cities[c(5,3)], 5)
plot(df_clean_cities[c(5,3)], col=clustering_income_hs$cluster)
```

Comprovem com es divideixen els cinc clusters que s'han creat. Amb aquesta divisió podríem agrupar les ciutats en 5 grups depenent dels seus ingressos mitjans.

## Contrast d'hipòtesis

En l'anàlisi preliminar de les dades hem vist que la distribució d'edats per ètnia no és igual per a totes. Les persones blanques assassinades solen ser més majors que la resta. Però aquesta diferència és significativa?

Per a saber-ho farem un contrast d'hipòtesi entre la mitjana de les edats de les persones blanques i les persones negres.

Les hipòtesis que farem seran les següents:
- $H_{0}$: $\mu_{1}=\mu_{2}$
- $H_{1}$: $\mu_{1}>\mu_{2}$

On $\mu_{1}$ serà la mitjana de les edats de les persones blanques assassinades i $\mu_{2}$ la mitjana d'edat de les persones negres assassinades.

Obtenim les dades de les persones blanques i negres:
```{r echo=TRUE, message=FALSE, warning=FALSE}
df_white <- df_clean[df_clean$race == "W",]
nrow(df_white)

df_black <- df_clean[df_clean$race == "B",]
nrow(df_black)
```
Comprovem que tenim 977 persones blanques i 534 persones negres.

Per a fer el contrast d'hipòtesi tindrem en conter el següent:

1. És un contrast de dues mostres independents perquè les persones dels distints conjunts no estan relacionades entre elles.

2. Podem assumir normalitat en les dades, ja que, en ser la mida de les mostres suficientment gran, podem aplicar el Teorema del Límit Central i assumir normalitat en les mitjanes de les mostres de la població.

3. Serà un test unilateral perquè volem saber si la mitjana de les edats de les persones blanques és major que la de les persones negres. Seria bilateral si sols volguérem saber si són diferents.

4. Per comprovar si existeix homoscedasticitat o heteroscedasticitat ens ajudarem de la funció var.test():
```{r echo=TRUE, message=FALSE, warning=FALSE}
var.test(df_white$age, df_black$age)
```

El p-valor resultant és molt menor que el nivell de significança 0.05, per tant, podem assumir que existeix heteroscedasticitat, les variàncies de les dues mostres són significativament diferents.

Amb aquestes comprovacions prèvies realitzades, fem el test. Indiquem alternative = "greater" per a indicar la nostra hipòtesi alternativa, var.equal = FALSE per a indicar que hi ha heteroscedasticitat i conf.level = 0.95 per indicar que volem un nivell de confiança del 95%.
```{r echo=TRUE, message=FALSE, warning=FALSE}
t.test(df_white$age, df_black$age, alternative = "greater", var.equal = FALSE, conf.level = 0.95)
```

Observem que el p-valor resultant és menor que el nivell de significança, per tant, podem rebutja la hipòtesi nul·la $H_0$ i afirmar, amb un nivell de confiança del 95%, que la mitjana de les edats de les persones blanques és major que la mitjana de les edats de les persones negres.

# 6. Resolució del problema. A partir dels resultats obtinguts, quines són les conclusions? Els resultats permeten respondre al problema?

Recordem les preguntes que ens havíem fet a l'inici:

- __Hi ha diferències d'ingressos mitjans d'una ciutat depenent de la distribució d'ètnies?__

- Hem vist gràficament la distribució d'ingressos depenent del percentatge de cada ètnia en la ciutat. Pareix que les ciutats amb més percentatge de persones hispanes o natives americanes tenen ingressos més baixos que ciutats amb percentatges alts de persones blanques. Però les diferències no eren molt grans.

- __Les ciutats es poden agrupar per alguna característica?__

- Si. Hem realitzat clustering amb el mètode kmeans() sobre les dades de les ciutats i hem obtingut 5 grups. La característica que més ens ha permés diferenciar aquests grups ha sigut l'ingrés mitja de les ciutats.

- __Podem estimar els ingressos mitjans d'una ciutat?__

- La resposta és sí. Hem creat tres models de regressió múltiple que ens permeten, encara que no siga d'una manera perfecta, estimar les variables de l'ingrés mitjà, percentatge de pobresa i percentatge de gent que ha superat els estudis superiors. Per a estimar els ingressos mitjans hem fet servir com a variables explicatives: share_white, share_black, share_hispanic, percent_completed_hs i poverty_rate.

- __Les víctimes mortals pertanyen majoritàriament a alguna ètnia?__

- En les dades que tenim, majoritàriament hi ha persones blanques. Com ja hem dit, açò és lògic, ja que en els Estats Units la majoria de persones són blanques. Però no podíem extraure conclusions a partir d'aquestes observacions, ja que no té gaire sentit comparar la quantitat de víctimes blanques o negres o hispanes sense saber la quantitat total de persones d'aquestes ètnies. Per això hem consultat les dades de la quantitat de persones de cada ètnia en 2017 i obtingut uns resultats d'on sí que podem extraure informació. En realitzar aquesta gràfica hem vist que les persones negres són les que més percentatge respecte a la seua població presenten de persones assassinades, seguides a prop per les persones hispanes i doblant a les persones blanques. Aquest resultat dóna arguments al moviment Black Lives Matter per exigir que es revisen aquests actes.

- __Predomina algun rang d'edat entre les persones que han sigut abatudes? Hi ha diferències entre ètnies?__

- En el gràfic de densitats comparat per ètnies hem vist que la majoria de persones assassinades solen tenir entre 20 i 40 anys. I també havíem vist que les persones blanques solien ser de més edat. Per comprovar si aquesta diferència era significativa, hem fet un contrast d'hipòtesi amb les edats de les persones blanques i les persones negres i hem arribat a la conclusió que, efectivament, les edats de les persones blanques són significativament majors que les edats de les persones negres assassinades.
